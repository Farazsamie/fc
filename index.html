<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FC</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <nav class="main-nav">
        <button class="nav-tab" data-view="learn" onclick="switchView('learn')">Active Recall</button>
        <button class="nav-tab active" data-view="create" onclick="switchView('create')">Create Card</button>
        <button class="nav-tab" data-view="analytics" onclick="switchView('analytics')">Analytics</button>
    </nav>

    <div class="container">
        <div class="app-wrapper">
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Categories</h3>
                    <div id="categoriesNav" class="categories-list">
                        <div id="categoriesNavList"></div>
                    </div>
                    <button onclick="openCategoryModal()" class="btn primary" style="width: 100%; margin-top: 10px;">+ New Category</button>
                </div>
            </aside>

            <main class="main-content">
                <div class="content active" id="create">
                    <h2>Flashcard Creation</h2>
                    <div class="form-container" style="max-width: 600px;">
                        <div class="form-group">
                            <label>Parent Category *</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 5px;">
                                <select id="parentCategoryInput" onchange="updateSubcategoryDropdown()">
                                    <option value="">-- Select a parent category --</option>
                                </select>
                                <button onclick="openParentCategoryModal()" class="btn secondary" style="padding: 8px 12px;">+ New</button>
                            </div>
                            <small>Select or create a parent category</small>
                        </div>

                        <div class="form-group">
                            <label>Subcategory *</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 5px;">
                                <select id="subcategoryInput">
                                    <option value="">-- Select a subcategory --</option>
                                </select>
                                <button onclick="openSubcategoryModal()" class="btn secondary" style="padding: 8px 12px;">+ New</button>
                            </div>
                            <small>Select from existing or create a new subcategory</small>
                        </div>

                        <div class="form-group">
                            <label>Front (Question)</label>
                            <textarea id="cardFront" placeholder="e.g., $\frac{d}{dx}x^2 = ?$"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Back (Answer)</label>
                            <textarea id="cardBack" placeholder="e.g., $2x$"></textarea>
                        </div>
                        <div class="button-group">
                            <button onclick="createCard()" class="btn primary">Save Card</button>
                            <button onclick="clearCardForm()" class="btn secondary">Clear</button>
                        </div>
                    </div>
                </div>

                <div class="content" id="learn">
                    <h2>Learn Flashcards</h2>
                    <div id="learnContainer"></div>
                </div>

                <div class="content" id="analytics">
                    <h2>Learning Analytics</h2>
                    <div id="analyticsContainer"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <button class="close" onclick="closeCategoryModal()">&times;</button>
            <h3>Create New Parent Category</h3>
            <div class="form-group">
                <label>Category Name</label>
                <input type="text" id="newCategoryName" placeholder="e.g., Mathematics">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="newCategoryDesc" placeholder="Optional description"></textarea>
            </div>
            <div class="button-group">
                <button onclick="createCategory()" class="btn primary">Create</button>
                <button onclick="closeCategoryModal()" class="btn secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="subcategoryModal" class="modal">
        <div class="modal-content">
            <button class="close" onclick="closeSubcategoryModal()">&times;</button>
            <h3>Create New Subcategory</h3>
            <div class="form-group">
                <label>Subcategory Name</label>
                <input type="text" id="newSubcategoryName" placeholder="e.g., Calculus">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="newSubcategoryDesc" placeholder="Optional description"></textarea>
            </div>
            <div class="button-group">
                <button onclick="createSubcategory()" class="btn primary">Create</button>
                <button onclick="closeSubcategoryModal()" class="btn secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="editCardModal" class="modal">
        <div class="modal-content">
            <button class="close" onclick="closeEditCardModal()">&times;</button>
            <h3>Edit Flashcard</h3>
            <div class="form-group">
                <label>Question</label>
                <textarea id="editCardFrontInput" placeholder="e.g., $\\frac{d}{dx}x^2 = ?$"></textarea>
            </div>
            <div class="form-group">
                <label>Answer</label>
                <textarea id="editCardBackInput" placeholder="e.g., $2x$"></textarea>
            </div>
            <div class="button-group">
                <button onclick="saveEditedCard()" class="btn primary">Save Changes</button>
                <button onclick="closeEditCardModal()" class="btn secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="answerFeedbackModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 style="margin-top: 0; text-align: center;">Answer</h3>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #3a3a3a; border-radius: 6px;">
                <div style="color: var(--accent-gray); margin-bottom: 8px; font-size: 0.9rem;">Inserted Answer:</div>
                <div id="userAnswerDisplay" style="font-size: 1rem; line-height: 1.6; color: #ccc; min-height: 40px;"></div>
            </div>

            <div id="feedbackCardContainer" style="background: var(--input-bg); border: 2px solid var(--accent-gray); padding: 40px; border-radius: 8px; min-height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                <div id="feedbackCardContent" style="text-align: center; width: 100%; font-size: 1.2rem; line-height: 1.8;">
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <p style="color: var(--accent-gray); font-size: 0.9rem; margin: 0;"> Confidence Level</p>
            </div>

            <div class="button-group">
                <button onclick="markCardCorrect()" class="btn" style="background: #90ff90; flex: 1; margin-bottom: 8px;"> Correct</button>
                <button onclick="markCardWrong()" class="btn" style="background: #690a0a; flex: 1;"> Incorrect</button>
            </div>
        </div>
    </div>

    <script>
        class StudyApp {
            constructor() {
                this.loadData();
            }

            loadData() {
                try {
                    const stored = localStorage.getItem('studyAppData');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.cards = data.cards || [];
                        this.parentCategories = data.parentCategories || this.createDefaultParentCategories();
                        this.subcategories = data.subcategories || this.createDefaultSubcategories();
                        this.cardStats = data.cardStats || {};
                    } else {
                        this.cards = [];
                        this.parentCategories = this.createDefaultParentCategories();
                        this.subcategories = this.createDefaultSubcategories();
                        this.cardStats = {};
                        this.saveData();
                    }
                } catch (e) {
                    console.log('localStorage not available, using session storage');
                    this.cards = [];
                    this.parentCategories = this.createDefaultParentCategories();
                    this.subcategories = this.createDefaultSubcategories();
                    this.cardStats = {};
                }
            }

            createDefaultParentCategories() {
                return [
                    {
                        id: 'cfa-level1',
                        name: 'CFA Level 1',
                        description: 'CFA Level 1 - Chartered Financial Analyst',
                        createdAt: new Date().toISOString()
                    }
                ];
            }

            createDefaultSubcategories() {
                return [
                    { id: 'cfa-l1-ethics', name: 'Ethics', parent: 'cfa-level1' },
                    { id: 'cfa-l1-accounting', name: 'Financial Reporting', parent: 'cfa-level1' },
                    { id: 'cfa-l1-economics', name: 'Economics', parent: 'cfa-level1' }
                ];
            }

            saveData() {
                try {
                    const data = {
                        cards: this.cards,
                        parentCategories: this.parentCategories,
                        subcategories: this.subcategories,
                        cardStats: this.cardStats
                    };
                    localStorage.setItem('studyAppData', JSON.stringify(data));
                } catch (e) {
                    console.log('Could not save to localStorage');
                }
            }

            createCard(front, back, parentCategoryId, subcategoryId) {
                const card = {
                    id: Date.now() + Math.random(),
                    front,
                    back,
                    parentCategory: parentCategoryId,
                    subcategory: subcategoryId,
                    created: new Date().toISOString(),
                    interval: 1,
                    easeFactor: 2.5,
                    nextReview: new Date().toISOString(),
                    timesReviewed: 0,
                    timesCorrect: 0,
                    timesWrong: 0,
                    streak: 0,
                    lastReviewTime: null
                };
                this.cards.push(card);
                this.cardStats[card.id] = {
                    attempts: [],
                    totalTimeMs: 0,
                    wrongAttempts: []
                };
                this.saveData();
                return card;
            }

            recordAttempt(cardId, isCorrect, timeMs) {
                const card = this.cards.find(c => c.id === cardId);
                if (!card) return;

                card.timesReviewed++;
                if (isCorrect) {
                    card.timesCorrect++;
                    card.streak++;
                } else {
                    card.timesWrong++;
                    card.streak = 0;
                    if (!this.cardStats[cardId]) this.cardStats[cardId] = { attempts: [], totalTimeMs: 0, wrongAttempts: [] };
                    this.cardStats[cardId].wrongAttempts.push({
                        timestamp: new Date().toISOString(),
                        timeMs
                    });
                }

                card.lastReviewTime = new Date().toISOString();

                if (!this.cardStats[cardId]) this.cardStats[cardId] = { attempts: [], totalTimeMs: 0, wrongAttempts: [] };
                this.cardStats[cardId].attempts.push({
                    timestamp: new Date().toISOString(),
                    isCorrect,
                    timeMs
                });
                this.cardStats[cardId].totalTimeMs += timeMs;

                // Update intervals for spaced repetition
                if (!isCorrect) {
                    card.interval = 1;
                } else {
                    if (card.timesCorrect === 1) card.interval = 1;
                    else if (card.timesCorrect === 2) card.interval = 3;
                    else card.interval = Math.round(card.interval * card.easeFactor);
                }

                const nextDate = new Date();
                nextDate.setDate(nextDate.getDate() + card.interval);
                card.nextReview = nextDate.toISOString();

                this.saveData();
            }

            deleteCard(cardId) {
                this.cards = this.cards.filter(c => c.id !== cardId);
                delete this.cardStats[cardId];
                this.saveData();
            }

            updateCard(cardId, front, back) {
                const card = this.cards.find(c => c.id === cardId);
                if (card) {
                    card.front = front;
                    card.back = back;
                    this.saveData();
                }
            }

            getAnalytics() {
                const stats = {
                    totalCards: this.cards.length,
                    totalAttempts: 0,
                    totalCorrect: 0,
                    totalWrong: 0,
                    averageAccuracy: 0,
                    mostMissedCards: [],
                    averageTimePerCard: 0,
                    cardsNeedingReview: 0
                };

                let totalTime = 0;
                const now = new Date();

                this.cards.forEach(card => {
                    stats.totalAttempts += card.timesReviewed;
                    stats.totalCorrect += card.timesCorrect;
                    stats.totalWrong += card.timesWrong;

                    if (new Date(card.nextReview) <= now) {
                        stats.cardsNeedingReview++;
                    }

                    if (this.cardStats[card.id]) {
                        totalTime += this.cardStats[card.id].totalTimeMs;
                    }
                });

                if (stats.totalAttempts > 0) {
                    stats.averageAccuracy = ((stats.totalCorrect / stats.totalAttempts) * 100).toFixed(1);
                }

                if (this.cards.length > 0) {
                    stats.averageTimePerCard = (totalTime / this.cards.length / 1000).toFixed(1);
                }

                // Find most missed cards
                stats.mostMissedCards = this.cards
                    .filter(c => c.timesWrong > 0)
                    .sort((a, b) => b.timesWrong - a.timesWrong)
                    .slice(0, 5);

                return stats;
            }
        }

        const app = new StudyApp();
        let currentCardId = null;
        let cardStartTime = null;
        let selectedSubcategoryId = null;
        let selectedParentCategoryId = null;
        let currentCardIndexForLearn = 0;
        let cardsForLearn = [];

        function switchView(viewName) {
            try {
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                const content = document.getElementById(viewName);
                if (content) {
                    content.classList.add('active');
                }

                document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
                const navBtn = document.querySelector(`.nav-tab[data-view="${viewName}"]`);
                if (navBtn) {
                    navBtn.classList.add('active');
                }

                if (viewName === 'learn') updateLearnView();
                if (viewName === 'analytics') updateAnalyticsView();
                if (viewName === 'create') updateParentCategoryDropdown();

                if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                    MathJax.typesetPromise().catch(err => console.log(err));
                }
            } catch (e) {
                console.error('Error switching view:', e);
            }
        }

        function updateParentCategoryDropdown() {
            const select = document.getElementById('parentCategoryInput');
            select.innerHTML = '<option value="">-- Select a parent category --</option>';
            app.parentCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }

        function updateSubcategoryDropdown() {
            const parentId = document.getElementById('parentCategoryInput').value;
            const subSelect = document.getElementById('subcategoryInput');
            subSelect.innerHTML = '<option value="">-- Select a subcategory --</option>';

            if (!parentId) return;

            const subs = app.subcategories.filter(s => s.parent === parentId);
            subs.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = sub.name;
                subSelect.appendChild(option);
            });
        }

        function openCategoryModal() {
            document.getElementById('categoryModal').classList.add('show');
        }

        function openParentCategoryModal() {
            document.getElementById('categoryModal').classList.add('show');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('show');
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryDesc').value = '';
        }

        function createCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name) {
                alert('Please enter a category name');
                return;
            }

            const id = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            if (app.parentCategories.find(c => c.id === id)) {
                alert('This category already exists');
                return;
            }

            app.parentCategories.push({
                id,
                name,
                description: document.getElementById('newCategoryDesc').value,
                createdAt: new Date().toISOString()
            });

            app.saveData();
            updateCategoriesNav();
            updateParentCategoryDropdown();
            closeCategoryModal();
            alert('Category created!');
        }

        function openSubcategoryModal() {
            const parentId = document.getElementById('parentCategoryInput').value;
            if (!parentId) {
                alert('Please select a parent category first');
                return;
            }
            document.getElementById('subcategoryModal').classList.add('show');
        }

        function closeSubcategoryModal() {
            document.getElementById('subcategoryModal').classList.remove('show');
            document.getElementById('newSubcategoryName').value = '';
            document.getElementById('newSubcategoryDesc').value = '';
        }

        function createSubcategory() {
            const parentId = document.getElementById('parentCategoryInput').value;
            const name = document.getElementById('newSubcategoryName').value.trim();

            if (!name) {
                alert('Please enter a subcategory name');
                return;
            }

            const id = parentId + '-' + name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');

            app.subcategories.push({
                id,
                name,
                parent: parentId
            });

            app.saveData();
            updateSubcategoryDropdown();
            updateCategoriesNav();
            document.getElementById('subcategoryInput').value = id;
            closeSubcategoryModal();
            alert('Subcategory created!');
        }

        function createCard() {
            const front = document.getElementById('cardFront').value.trim();
            const back = document.getElementById('cardBack').value.trim();
            const parentId = document.getElementById('parentCategoryInput').value.trim();
            const subId = document.getElementById('subcategoryInput').value.trim();

            if (!front || !back || !parentId || !subId) {
                alert('Please fill in all fields');
                return;
            }

            app.createCard(front, back, parentId, subId);
            clearCardForm();
            updateCategoriesNav();
            alert('Card created successfully!');
        }

        function clearCardForm() {
            document.getElementById('cardFront').value = '';
            document.getElementById('cardBack').value = '';
            document.getElementById('parentCategoryInput').value = '';
            document.getElementById('subcategoryInput').value = '';
        }

        function updateCategoriesNav() {
            const navList = document.getElementById('categoriesNavList');
            
            if (app.parentCategories.length === 0) {
                navList.innerHTML = '<p style="color: var(--accent-gray); font-size: 0.9rem;">No categories yet</p>';
                return;
            }

            let html = '';
            
            app.parentCategories.forEach(parent => {
                const subs = app.subcategories.filter(s => s.parent === parent.id);
                const parentCards = app.cards.filter(c => c.parentCategory === parent.id).length;
                
                html += `
                    <div style="margin-bottom: 12px;">
                        <div style="background: #2d2d2d; border: 1px solid #555; padding: 10px; border-radius: 4px; margin-bottom: 8px; cursor: pointer;" onclick="selectParentCategory('${parent.id}')">
                            <div style="font-weight: 600; color: var(--text-light);">${parent.name}</div>
                            <div style="font-size: 0.8rem; color: var(--accent-gray); margin-top: 2px;">${parentCards} cards</div>
                        </div>
                        ${subs.length > 0 ? `
                            <div style="padding-left: 12px;">
                                ${subs.map(sub => {
                                    const subCards = app.cards.filter(c => c.subcategory === sub.id).length;
                                    return `
                                        <button onclick="selectSubcategory('${sub.id}')" style="background: #3a3a3a; border: 1px solid #444; padding: 8px 12px; border-radius: 3px; color: var(--text-light); width: 100%; text-align: left; font-size: 0.85rem; margin-bottom: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                            <span>${sub.name}</span>
                                            <span style="font-size: 0.7rem; background: #1b1a1a; padding: 2px 6px; border-radius: 2px;">${subCards}</span>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            navList.innerHTML = html;
        }

        function selectSubcategory(subcategoryId) {
            selectedSubcategoryId = subcategoryId;
            selectedParentCategoryId = null;
            switchView('learn');
        }

        function selectParentCategory(parentId) {
            selectedParentCategoryId = parentId;
            selectedSubcategoryId = null;
            switchView('learn');
        }

        function displayCurrentCard() {
            const container = document.getElementById('learnContainer');
            if (currentCardIndexForLearn >= cardsForLearn.length) {
                container.innerHTML = '<p style="color: var(--accent-gray); font-size: 1.2rem; margin-top: 20px;"> </p>';
                return;
            }

            const card = cardsForLearn[currentCardIndexForLearn];
            currentCardId = card.id;
            cardStartTime = Date.now();

            container.innerHTML = `
                <div style="max-width: 600px;">
                    <p style="color: var(--accent-gray); margin-bottom: 15px;">Card ${currentCardIndexForLearn + 1} of ${cardsForLearn.length}</p>
                    <div class="study-card" style="min-height: 200px; display: flex; flex-direction: column; justify-content: space-between; padding: 30px; margin-bottom: 20px;">
                        <div>
                            <div style="color: var(--accent-gray); margin-bottom: 15px; font-size: 0.9rem;">QUESTION:</div>
                            <div style="font-size: 1.15rem; text-align: center; margin: 20px 0; line-height: 1.8;">
                                ${card.front}
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <div style="color: var(--accent-gray); margin-bottom: 10px; font-size: 0.9rem;">ANSWER:</div>
                            <textarea id="userAnswerInput" placeholder="Try typing part or all of the answer before revealing..." style="background: #3a3a3a; border: 1px solid #5a7a8c; color: var(--text-light); padding: 12px; border-radius: 4px; width: 100%; min-height: 60px; resize: vertical; font-size: 0.95rem;"></textarea>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="previousLearnCard()" class="btn secondary" style="flex: 1;">‚Üê Previous</button>
                        <button onclick="revealAnswer()" class="btn primary" style="flex: 1;">Reveal Answer</button>
                    </div>
                </div>
            `;

            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                setTimeout(() => MathJax.typesetPromise().catch(err => console.log(err)), 100);
            }
        }

        function revealAnswer() {
            const card = app.cards.find(c => c.id === currentCardId);
            if (!card) {
                console.log('Card not found:', currentCardId);
                return;
            }

            // Get user's typed answer
            const userAnswerEl = document.getElementById('userAnswerInput');
            const userAnswer = userAnswerEl ? userAnswerEl.value : '';
            const displayAnswer = userAnswer || '(You didn\'t write anything)';
            
            document.getElementById('userAnswerDisplay').innerHTML = displayAnswer;
            document.getElementById('feedbackCardContent').innerHTML = card.back;
            document.getElementById('answerFeedbackModal').classList.add('show');

            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                setTimeout(() => MathJax.typesetPromise().catch(err => console.log(err)), 100);
            }
        }

        function markCardCorrect() {
            const timeMs = Date.now() - cardStartTime;
            app.recordAttempt(currentCardId, true, timeMs);
            document.getElementById('answerFeedbackModal').classList.remove('show');
            currentCardIndexForLearn++;
            displayCurrentCard();
        }

        function markCardWrong() {
            const timeMs = Date.now() - cardStartTime;
            app.recordAttempt(currentCardId, false, timeMs);
            document.getElementById('answerFeedbackModal').classList.remove('show');
            currentCardIndexForLearn++;
            displayCurrentCard();
        }

        function previousLearnCard() {
            if (currentCardIndexForLearn > 0) {
                currentCardIndexForLearn--;
                displayCurrentCard();
            }
        }

        function updateLearnView() {
            const container = document.getElementById('learnContainer');
            let cards = app.cards;

            // Filter by parent or subcategory
            if (selectedParentCategoryId) {
                cards = cards.filter(c => c.parentCategory === selectedParentCategoryId);
            } else if (selectedSubcategoryId) {
                cards = cards.filter(c => c.subcategory === selectedSubcategoryId);
            }

            if (cards.length === 0) {
                container.innerHTML = '<p>No cards to study. <a href="#" onclick="switchView(\'create\')" style="color: #5a7a8c;">Create one!</a></p>';
                return;
            }

            cardsForLearn = cards;
            currentCardIndexForLearn = 0;
            displayCurrentCard();
        }

        function updateAnalyticsView() {
            const stats = app.getAnalytics();
            const container = document.getElementById('analyticsContainer');

            let html = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">${stats.totalCards}</div>
                        <div class="stat-label">Total Cards</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.totalAttempts}</div>
                        <div class="stat-label">Total Attempts</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.averageAccuracy}%</div>
                        <div class="stat-label">Accuracy Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.cardsNeedingReview}</div>
                        <div class="stat-label">Need Review</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.totalCorrect}</div>
                        <div class="stat-label">Correct Attempts</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.totalWrong}</div>
                        <div class="stat-label">Wrong Attempts</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.averageTimePerCard}s</div>
                        <div class="stat-label">Avg Time per Card</div>
                    </div>
                </div>
            `;

            if (stats.mostMissedCards.length > 0) {
                html += `
                    <div style="margin-top: 40px;">
                        <h3>Cards You Find Difficult (Most Wrong)</h3>
                        <div style="display: grid; gap: 12px;">
                `;

                stats.mostMissedCards.forEach(card => {
                    const accuracy = card.timesReviewed > 0 ? ((card.timesCorrect / card.timesReviewed) * 100).toFixed(1) : 0;
                    const sub = app.subcategories.find(s => s.id === card.subcategory);
                    html += `
                        <div style="background: var(--card-bg); padding: 15px; border-radius: 6px; border-left: 4px solid #8b4545;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 5px;">Q: ${card.front}</div>
                                    <div style="color: #999; font-size: 0.9rem; margin-bottom: 8px;">A: ${card.back}</div>
                                    <div style="font-size: 0.85rem; color: var(--accent-gray);">
                                        Wrong: ${card.timesWrong}x | Accuracy: ${accuracy}% | Category: ${sub ? sub.name : 'Unknown'}
                                    </div>
                                </div>
                                <button onclick="editCard('${card.id}')" class="btn secondary" style="padding: 6px 12px; font-size: 0.85rem;">Edit</button>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            // Show all cards with edit/delete options
            html += `
                <div style="margin-top: 40px;">
                    <h3>All Cards</h3>
                    <div style="display: grid; gap: 12px;">
            `;

            app.cards.forEach(card => {
                const accuracy = card.timesReviewed > 0 ? ((card.timesCorrect / card.timesReviewed) * 100).toFixed(1) : 0;
                const sub = app.subcategories.find(s => s.id === card.subcategory);
                
                html += `
                    <div style="background: var(--card-bg); padding: 15px; border-radius: 6px; border-left: 4px solid ${card.timesWrong > 2 ? '#8b4545' : '#4a6a4a'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 5px;">Q: ${card.front}</div>
                                <div style="color: #999; font-size: 0.9rem; margin-bottom: 8px;">A: ${card.back}</div>
                                <div style="font-size: 0.85rem; color: var(--accent-gray);">
                                    Reviewed: ${card.timesReviewed}x | Correct: ${card.timesCorrect}x | Wrong: ${card.timesWrong}x | Accuracy: ${accuracy}%
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; white-space: nowrap;">
                                <button onclick="editCard('${card.id}')" class="btn secondary" style="padding: 6px 12px; font-size: 0.85rem;">Edit</button>
                                <button onclick="deleteCard('${card.id}')" class="btn" style="background: #6a4a4a; padding: 6px 12px; font-size: 0.85rem; border: none; cursor: pointer;">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            container.innerHTML = html;
        }

        let currentEditCardId = null;

        function editCard(cardId) {
            currentEditCardId = cardId;
            const card = app.cards.find(c => c.id === cardId);
            if (!card) return;

            document.getElementById('editCardFrontInput').value = card.front;
            document.getElementById('editCardBackInput').value = card.back;
            document.getElementById('editCardModal').classList.add('show');
        }

        function closeEditCardModal() {
            document.getElementById('editCardModal').classList.remove('show');
            currentEditCardId = null;
        }

        function saveEditedCard() {
            if (!currentEditCardId) return;

            const front = document.getElementById('editCardFrontInput').value.trim();
            const back = document.getElementById('editCardBackInput').value.trim();

            if (!front || !back) {
                alert('Please fill in both fields');
                return;
            }

            app.updateCard(currentEditCardId, front, back);
            closeEditCardModal();
            updateAnalyticsView();
            alert('Card updated!');
        }

        function deleteCard(cardId) {
            if (confirm('Delete this card?')) {
                app.deleteCard(cardId);
                updateAnalyticsView();
                updateCategoriesNav();
            }
        }

        document.addEventListener('click', (e) => {
            if (e.target.id === 'categoryModal') {
                closeCategoryModal();
            }
            if (e.target.id === 'subcategoryModal') {
                closeSubcategoryModal();
            }
            if (e.target.id === 'editCardModal') {
                closeEditCardModal();
            }
            if (e.target.id === 'answerFeedbackModal') {
                document.getElementById('answerFeedbackModal').classList.remove('show');
            }
        });

        function initApp() {
            try {
                updateCategoriesNav();
                updateParentCategoryDropdown();

                if (typeof MathJax !== 'undefined') {
                    MathJax.contentDocument = document;
                }
            } catch (e) {
                console.error('Initialization error:', e);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(initApp, 100);
            });
        } else {
            setTimeout(initApp, 100);
        }
    </script>
</body>
</html>