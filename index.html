<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FC</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEnvironments: true,
                packages: ['base', 'ams', 'noerrors', 'noundefined', 'mathtools']
            },
            svg: { fontCache: 'global' },
            startup: {
                pageReady: () => {
                    return MathJax.typesetPromise();
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>


<body>
    <nav class="main-nav">
        <button class="nav-tab" data-view="learn" onclick="switchView('learn')">Active Recall</button>
        <button class="nav-tab active" data-view="create" onclick="switchView('create')">Create Card</button>
        <button class="nav-tab" data-view="analytics" onclick="switchView('analytics')">Analytics</button>
    </nav>

    <div class="container">
        <div class="app-wrapper">
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Categories</h3>
                    <div id="categoriesNav" class="categories-list">
                        <div id="categoriesNavList"></div>
                    </div>
                    <button onclick="openCategoryModal()" class="btn primary" style="width: 100%; margin-top: 10px;">+ New Category</button>
                </div>
            </aside>

            <main class="main-content">
                <div class="content active" id="create">
                    <div class="form-container" style="max-width: 600px;">
                        <div style="background: #2d2d2d; border-left: 4px solid #5a7a8c; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">üìù Content Tips:</div>
                            <ul style="margin: 8px 0; padding-left: 20px; font-size: 0.9rem; color: var(--accent-gray);">
                                <li><strong>Math:</strong> Inline with <code style="background: #1a1a1a; padding: 2px 6px; border-radius: 2px;">$E=mc^2$</code> or display <code style="background: #1a1a1a; padding: 2px 6px; border-radius: 2px;">$$x^2$$</code></li>
                                <li><strong>Multiple Choice:</strong> Use HTML <code style="background: #1a1a1a; padding: 2px 6px; border-radius: 2px;">&lt;ol&gt;&lt;li&gt;A&lt;/li&gt;&lt;/ol&gt;</code> or LaTeX <code style="background: #1a1a1a; padding: 2px 6px; border-radius: 2px;">$$\begin{align}A. & \text{ option}\end{align}$$</code></li>
                                <li><strong>Fractions:</strong> <code style="background: #1a1a1a; padding: 2px 6px; border-radius: 2px;">$\frac{numerator}{denominator}$</code></li>
                                <li><strong>Line Breaks in Math:</strong> Use <code style="background: #1a1a1a; padding: 2px 6px; border-radius: 2px;">\\</code> in align/array environments or plain text lines</li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label>Parent Category *</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 5px;">
                                <select id="parentCategoryInput" onchange="updateSubcategoryDropdown()">
                                    <option value="">-- Select a parent category --</option>
                                </select>
                                <button onclick="openParentCategoryModal()" class="btn secondary" style="padding: 8px 12px;">+ New</button>
                            </div>
                            <small>Select or create a parent category</small>
                        </div>

                        <div class="form-group">
                            <label>Subcategory *</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 5px;">
                                <select id="subcategoryInput">
                                    <option value=""> - Select a subcategory - </option>
                                </select>
                                <button onclick="openSubcategoryModal()" class="btn secondary" style="padding: 8px 12px;">+ New</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Front (Question)</label>
                            <textarea id="cardFront" placeholder="Math: $2x+3$ or $$x^2=4$$. Lists: Use HTML <ol><li>A - option</li></ol> or align: $$\begin{align}A. & \text{ option}\\B. & \text{ option}\end{align}$$"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Back (Answer)</label>
                            <textarea id="cardBack" placeholder="Inline math: $E=mc^2$. Display: $$\frac{a}{b}$$. HTML lists and text work too!"></textarea>
                        </div>
                        <div class="button-group">
                            <button onclick="createCard()" class="btn primary">Save Card</button>
                            <button onclick="clearCardForm()" class="btn secondary">Clear</button>
                        </div>
                    </div>
                </div>

                <div class="content" id="learn">
                    
                    <!-- Study Mode Selector -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; max-width: 600px;">
                        <button onclick="setStudyMode('all')" id="modeAll" class="btn secondary" style="flex: 1;">All Cards</button>
                        <button onclick="setStudyMode('new')" id="modeNew" class="btn secondary" style="flex: 1;">New Only</button>
                        <button onclick="setStudyMode('wrong')" id="modeWrong" class="btn secondary" style="flex: 1;">Missed Cards</button>
                    </div>

                    <div id="learnContainer"></div>
                </div>

                <div class="content" id="analytics">
                    <h2>Learning Analytics</h2>
                    <div id="analyticsContainer"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <button class="close" onclick="closeCategoryModal()">&times;</button>
            <h3>Create New Parent Category</h3>
            <div class="form-group">
                <label>Category Name</label>
                <input type="text" id="newCategoryName" placeholder="e.g., Mathematics">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="newCategoryDesc" placeholder="Optional description"></textarea>
            </div>
            <div class="button-group">
                <button onclick="createCategory()" class="btn primary">Create</button>
                <button onclick="closeCategoryModal()" class="btn secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="subcategoryModal" class="modal">
        <div class="modal-content">
            <button class="close" onclick="closeSubcategoryModal()">&times;</button>
            <h3>Create New Subcategory</h3>
            <div class="form-group">
                <label>Subcategory Name</label>
                <input type="text" id="newSubcategoryName" placeholder="e.g., Calculus">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="newSubcategoryDesc" placeholder="Optional description"></textarea>
            </div>
            <div class="button-group">
                <button onclick="createSubcategory()" class="btn primary">Create</button>
                <button onclick="closeSubcategoryModal()" class="btn secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="editCardModal" class="modal">
        <div class="modal-content">
            <button class="close" onclick="closeEditCardModal()">&times;</button>
            <h3>Edit Flashcard</h3>
            <div class="form-group">
                <label>Question</label>
                <textarea id="editCardFrontInput" placeholder="Math: $2x$ or $$x^2$$. HTML: <ol><li>A</li><li>B</li></ol>. Align: $$\begin{align}A. & \text{ option}\end{align}$$"></textarea>
            </div>
            <div class="form-group">
                <label>Answer</label>
                <textarea id="editCardBackInput" placeholder="Inline: $E=mc^2$. Display: $$\frac{a}{b}$$. Mix LaTeX math with HTML!"></textarea>
            </div>
            <div class="button-group">
                <button onclick="saveEditedCard()" class="btn primary">Save Changes</button>
                <button onclick="closeEditCardModal()" class="btn secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="answerFeedbackModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 style="margin-top: 0; text-align: left;">Answer Revealed</h3>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #3a3a3a; border-radius: 6px;">
                <div style="color: var(--accent-gray); margin-bottom: 8px; font-size: 0.9rem;">YOUR ANSWER:</div>
                <div id="userAnswerDisplay" style="font-size: 1rem; line-height: 1.6; color: #ccc; min-height: 40px; white-space: pre-wrap;"></div>
            </div>

            <div id="feedbackCardContainer" style="background: var(--input-bg); border: 2px solid var(--accent-gray); padding: 25px; border-radius: 8px; min-height: 350px; max-height: 500px; display: flex; align-items: flex-start; justify-content: flex-start; margin-bottom: 20px; overflow-y: auto;">
                <div id="feedbackCardContent" style="text-align: left; width: 100%; font-size: 0.9rem; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word;">
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button onclick="markCardConfidence(3)" class="btn" style="background: #1d1c1c; padding: 14px;">‚úì Perfect </button>
                <button onclick="markCardConfidence(2)" class="btn" style="background: #1d1c1c; padding: 14px;">‚úì Good </button>
                <button onclick="markCardConfidence(1)" class="btn" style="background: #1d1c1c; padding: 14px;">~ Partial </button>
                <button onclick="markCardConfidence(0)" class="btn" style="background: #1d1c1c; padding: 14px;">‚úó Wrong </button>
            </div>
        </div>
    </div>

    <script>
        class StudyApp {
            constructor() {
                this.loadData();
            }

            loadData() {
                try {
                    const stored = localStorage.getItem('studyAppData');
                    console.log('Loading data from localStorage:', stored ? 'Found' : 'Not found');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.cards = data.cards || [];
                        this.parentCategories = data.parentCategories || this.createDefaultParentCategories();
                        this.subcategories = data.subcategories || this.createDefaultSubcategories();
                        this.cardStats = data.cardStats || {};
                        console.log('Loaded cards:', this.cards.length);
                    } else {
                        this.cards = [];
                        this.parentCategories = this.createDefaultParentCategories();
                        this.subcategories = this.createDefaultSubcategories();
                        this.cardStats = {};
                        this.saveData();
                    }
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                    this.cards = [];
                    this.parentCategories = this.createDefaultParentCategories();
                    this.subcategories = this.createDefaultSubcategories();
                    this.cardStats = {};
                }
            }

            createDefaultParentCategories() {
                return [
                    {
                        id: 'cfa-level1',
                        name: 'CFA Level 1',
                        description: 'CFA Level 1 - Chartered Financial Analyst',
                        createdAt: new Date().toISOString()
                    }
                ];
            }

            createDefaultSubcategories() {
                return [
                    { id: 'cfa-l1-ethics', name: 'Ethical and Professional Standards', parent: 'cfa-level1' },
                    { id: 'cfa-l1-quantitative-methods', name: 'Quantitative Methods', parent: 'cfa-level1' },
                    { id: 'cfa-l1-economics', name: 'Economics', parent: 'cfa-level1' },
                    { id: 'cfa-l1-financial-statement', name: 'Financial Statement Analysis', parent: 'cfa-level1' },
                    { id: 'cfa-l1-corporate-issuers', name: 'Corporate Issuers', parent: 'cfa-level1' },
                    { id: 'cfa-l1-equity-investments', name: 'Equity Investments', parent: 'cfa-level1' },
                    { id: 'cfa-l1-fixed-income', name: 'Fixed Income', parent: 'cfa-level1' },
                    { id: 'cfa-l1-derivatives', name: 'Derivatives', parent: 'cfa-level1' },
                    { id: 'cfa-l1-alternative-investments', name: 'Alternative Investments', parent: 'cfa-level1' },
                    { id: 'cfa-l1-portfolio-management', name: 'Portfolio Management', parent: 'cfa-level1' }
                ];
            }

            saveData() {
                try {
                    const data = {
                        cards: this.cards,
                        parentCategories: this.parentCategories,
                        subcategories: this.subcategories,
                        cardStats: this.cardStats
                    };
                    localStorage.setItem('studyAppData', JSON.stringify(data));
                    console.log('Data saved to localStorage. Total cards:', this.cards.length);
                } catch (e) {
                    console.error('Could not save to localStorage:', e);
                }
            }

            createCard(front, back, parentCategoryId, subcategoryId) {
                const card = {
                    id: Date.now() + Math.random(),
                    front,
                    back,
                    parentCategory: parentCategoryId,
                    subcategory: subcategoryId,
                    created: new Date().toISOString(),
                    interval: 1,
                    easeFactor: 2.5,
                    nextReview: new Date().toISOString(),
                    timesReviewed: 0,
                    timesCorrect: 0,
                    timesWrong: 0,
                    streak: 0,
                    lastReviewTime: null,
                    confidenceLevel: 0
                };
                this.cards.push(card);
                this.cardStats[card.id] = {
                    attempts: [],
                    totalTimeMs: 0,
                    wrongAttempts: [],
                    confidenceHistory: []
                };
                this.saveData();
                return card;
            }

            recordAttempt(cardId, confidence, timeMs) {
                const card = this.cards.find(c => c.id === cardId);
                if (!card) return;

                const isCorrect = confidence >= 2;

                card.timesReviewed++;
                if (isCorrect) {
                    card.timesCorrect++;
                    card.streak++;
                } else {
                    card.timesWrong++;
                    card.streak = 0;
                    if (!this.cardStats[cardId]) this.cardStats[cardId] = { attempts: [], totalTimeMs: 0, wrongAttempts: [], confidenceHistory: [] };
                    this.cardStats[cardId].wrongAttempts.push({
                        timestamp: new Date().toISOString(),
                        timeMs,
                        confidence
                    });
                }

                card.confidenceLevel = confidence;
                card.lastReviewTime = new Date().toISOString();

                if (!this.cardStats[cardId]) this.cardStats[cardId] = { attempts: [], totalTimeMs: 0, wrongAttempts: [], confidenceHistory: [] };
                this.cardStats[cardId].attempts.push({
                    timestamp: new Date().toISOString(),
                    isCorrect,
                    timeMs,
                    confidence
                });
                this.cardStats[cardId].confidenceHistory.push(confidence);
                this.cardStats[cardId].totalTimeMs += timeMs;

                if (confidence === 0) {
                    card.interval = 1;
                    card.easeFactor = Math.max(1.3, card.easeFactor - 0.2);
                } else if (confidence === 1) {
                    card.interval = 1;
                    card.easeFactor = Math.max(1.3, card.easeFactor - 0.15);
                } else if (confidence === 2) {
                    if (card.timesCorrect === 1) card.interval = 1;
                    else if (card.timesCorrect === 2) card.interval = 3;
                    else card.interval = Math.round(card.interval * card.easeFactor);
                } else if (confidence === 3) {
                    if (card.timesCorrect === 1) card.interval = 3;
                    else if (card.timesCorrect === 2) card.interval = 7;
                    else card.interval = Math.round(card.interval * card.easeFactor * 1.3);
                    card.easeFactor = Math.min(2.5, card.easeFactor + 0.1);
                }

                const nextDate = new Date();
                nextDate.setDate(nextDate.getDate() + card.interval);
                card.nextReview = nextDate.toISOString();

                this.saveData();
            }

            deleteCard(cardId) {
                console.log('Deleting card:', cardId);
                this.cards = this.cards.filter(c => c.id !== cardId);
                delete this.cardStats[cardId];
                this.saveData();
                console.log('Card deleted. Remaining cards:', this.cards.length);
            }

            updateCard(cardId, front, back) {
                console.log('Updating card:', cardId);
                const card = this.cards.find(c => c.id === cardId);
                if (card) {
                    card.front = front;
                    card.back = back;
                    this.saveData();
                    console.log('Card updated successfully');
                }
            }

            getAnalytics() {
                const stats = {
                    totalAttempts: 0,
                    totalCorrect: 0,
                    totalWrong: 0,
                    averageAccuracy: 0,
                    mostMissedCards: [],
                    averageTimePerCard: 0,
                    averageConfidence: 0,
                    masteredCards: 0,
                    strugglingCards: 0
                };

                let totalTime = 0;
                let totalConfidence = 0;
                let cardsWithReviews = 0;

                this.cards.forEach(card => {
                    stats.totalAttempts += card.timesReviewed;
                    stats.totalCorrect += card.timesCorrect;
                    stats.totalWrong += card.timesWrong;

                    if (card.timesReviewed > 0) {
                        cardsWithReviews++;
                        totalConfidence += card.confidenceLevel;
                    }

                    if (card.streak >= 3 && card.confidenceLevel === 3) {
                        stats.masteredCards++;
                    }

                    if (card.timesWrong > card.timesCorrect && card.timesReviewed > 2) {
                        stats.strugglingCards++;
                    }

                    if (this.cardStats[card.id]) {
                        totalTime += this.cardStats[card.id].totalTimeMs;
                    }
                });

                if (stats.totalAttempts > 0) {
                    stats.averageAccuracy = ((stats.totalCorrect / stats.totalAttempts) * 100).toFixed(1);
                }

                if (cardsWithReviews > 0) {
                    stats.averageConfidence = (totalConfidence / cardsWithReviews).toFixed(2);
                    stats.averageTimePerCard = (totalTime / cardsWithReviews / 1000).toFixed(1);
                }

                stats.mostMissedCards = this.cards
                    .filter(c => c.timesWrong > 0)
                    .sort((a, b) => {
                        const aRatio = a.timesWrong / (a.timesReviewed || 1);
                        const bRatio = b.timesWrong / (b.timesReviewed || 1);
                        return bRatio - aRatio;
                    })
                    .slice(0, 10);

                return stats;
            }

            getCardsByMode(mode, filterCategory = null) {
                let cards = this.cards;

                if (filterCategory) {
                    if (filterCategory.type === 'parent') {
                        cards = cards.filter(c => c.parentCategory === filterCategory.id);
                    } else if (filterCategory.type === 'sub') {
                        cards = cards.filter(c => c.subcategory === filterCategory.id);
                    }
                }

                if (mode === 'new') {
                    return cards.filter(c => c.timesReviewed === 0);
                } else if (mode === 'wrong') {
                    return cards.filter(c => c.timesWrong > 0);
                } else {
                    return cards;
                }
            }
        }

        const app = new StudyApp();
        let currentCardId = null;
        let cardStartTime = null;
        let selectedSubcategoryId = null;
        let selectedParentCategoryId = null;
        let currentCardIndexForLearn = 0;
        let cardsForLearn = [];
        let currentStudyMode = 'all';
        let shownCardIds = new Set();

        function setStudyMode(mode) {
            currentStudyMode = mode;
            
            document.querySelectorAll('#modeAll, #modeNew, #modeWrong').forEach(btn => {
                btn.style.background = '#3a3a3a';
                btn.style.borderColor = '#444';
            });
            
            const activeBtn = document.getElementById('mode' + mode.charAt(0).toUpperCase() + mode.slice(1));
            if (activeBtn) {
                activeBtn.style.background = '#5a7a8c';
                activeBtn.style.borderColor = '#5a7a8c';
            }
            
            updateLearnView();
        }

        function switchView(viewName) {
            try {
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                const content = document.getElementById(viewName);
                if (content) {
                    content.classList.add('active');
                }

                document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
                const navBtn = document.querySelector(`.nav-tab[data-view="${viewName}"]`);
                if (navBtn) {
                    navBtn.classList.add('active');
                }

                if (viewName === 'learn') {
                    updateLearnView();
                    setStudyMode('all');
                }
                if (viewName === 'analytics') updateAnalyticsView();
                if (viewName === 'create') updateParentCategoryDropdown();

                setTimeout(() => {
                    if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                        MathJax.typesetPromise().catch(err => console.log(err));
                    }
                }, 50);
            } catch (e) {
                console.error('Error switching view:', e);
            }
        }

        function updateParentCategoryDropdown() {
            const select = document.getElementById('parentCategoryInput');
            select.innerHTML = '<option value="">- Select a parent category - </option>';
            app.parentCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }

        function updateSubcategoryDropdown() {
            const parentId = document.getElementById('parentCategoryInput').value;
            const subSelect = document.getElementById('subcategoryInput');
            subSelect.innerHTML = '<option value=""> - Select a subcategory - </option>';

            if (!parentId) return;

            const subs = app.subcategories.filter(s => s.parent === parentId);
            subs.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = sub.name;
                subSelect.appendChild(option);
            });
        }

        function openCategoryModal() {
            document.getElementById('categoryModal').classList.add('show');
        }

        function openParentCategoryModal() {
            document.getElementById('categoryModal').classList.add('show');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('show');
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryDesc').value = '';
        }

        function createCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name) {
                alert('Please enter a category name');
                return;
            }

            const id = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            if (app.parentCategories.find(c => c.id === id)) {
                alert('This category already exists');
                return;
            }

            app.parentCategories.push({
                id,
                name,
                description: document.getElementById('newCategoryDesc').value,
                createdAt: new Date().toISOString()
            });

            app.saveData();
            updateCategoriesNav();
            updateParentCategoryDropdown();
            closeCategoryModal();
            alert('Category created!');
        }

        function openSubcategoryModal() {
            const parentId = document.getElementById('parentCategoryInput').value;
            if (!parentId) {
                alert('Please select a parent category first');
                return;
            }
            document.getElementById('subcategoryModal').classList.add('show');
        }

        function closeSubcategoryModal() {
            document.getElementById('subcategoryModal').classList.remove('show');
            document.getElementById('newSubcategoryName').value = '';
            document.getElementById('newSubcategoryDesc').value = '';
        }

        function createSubcategory() {
            const parentId = document.getElementById('parentCategoryInput').value;
            const name = document.getElementById('newSubcategoryName').value.trim();

            if (!name) {
                alert('Please enter a subcategory name');
                return;
            }

            const id = parentId + '-' + name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');

            app.subcategories.push({
                id,
                name,
                parent: parentId
            });

            app.saveData();
            updateSubcategoryDropdown();
            updateCategoriesNav();
            document.getElementById('subcategoryInput').value = id;
            closeSubcategoryModal();
            alert('Subcategory created!');
        }

        function createCard() {
            const front = document.getElementById('cardFront').value.trim();
            const back = document.getElementById('cardBack').value.trim();
            const parentId = document.getElementById('parentCategoryInput').value.trim();
            const subId = document.getElementById('subcategoryInput').value.trim();

            if (!front || !back || !parentId || !subId) {
                alert('Please fill in all fields');
                return;
            }

            app.createCard(front, back, parentId, subId);
            clearCardForm();
            updateCategoriesNav();
            alert('Card created successfully!');
        }

        function clearCardForm() {
            document.getElementById('cardFront').value = '';
            document.getElementById('cardBack').value = '';
            document.getElementById('parentCategoryInput').value = '';
            document.getElementById('subcategoryInput').value = '';
        }

        function updateCategoriesNav() {
            const navList = document.getElementById('categoriesNavList');
            
            if (app.parentCategories.length === 0) {
                navList.innerHTML = '<p style="color: var(--accent-gray); font-size: 0.9rem;">No categories yet</p>';
                return;
            }

            let html = '';
            
            app.parentCategories.forEach(parent => {
                const subs = app.subcategories.filter(s => s.parent === parent.id);
                const parentCards = app.cards.filter(c => c.parentCategory === parent.id).length;
                
                html += `
                    <div style="margin-bottom: 12px;">
                        <div style="background: #2d2d2d; border: 1px solid #555; padding: 10px; border-radius: 4px; margin-bottom: 8px; cursor: pointer;" onclick="selectParentCategory('${parent.id}')">
                            <div style="font-weight: 600; color: var(--text-light);">${parent.name}</div>
                            <div style="font-size: 0.8rem; color: var(--accent-gray); margin-top: 2px;">${parentCards} cards</div>
                        </div>
                        ${subs.length > 0 ? `
                            <div style="padding-left: 12px;">
                                ${subs.map(sub => {
                                    const subCards = app.cards.filter(c => c.subcategory === sub.id).length;
                                    return `
                                        <button onclick="selectSubcategory('${sub.id}')" style="background: #3a3a3a; border: 1px solid #444; padding: 8px 12px; border-radius: 3px; color: var(--text-light); width: 100%; text-align: left; font-size: 0.85rem; margin-bottom: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: left;">
                                            <span>${sub.name}</span>
                                            <span style="font-size: 0.7rem; background: #1b1a1a; padding: 2px 6px; border-radius: 2px;">${subCards}</span>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            navList.innerHTML = html;
        }

        function selectSubcategory(subcategoryId) {
            selectedSubcategoryId = subcategoryId;
            selectedParentCategoryId = null;
            switchView('learn');
        }

        function selectParentCategory(parentId) {
            selectedParentCategoryId = parentId;
            selectedSubcategoryId = null;
            switchView('learn');
        }

        function displayCurrentCard() {
            const container = document.getElementById('learnContainer');
            
            if (currentCardIndexForLearn >= cardsForLearn.length) {
                const wrongCards = cardsForLearn.filter(c => c.timesWrong > 0 && !shownCardIds.has(c.id + '_repeat'));
                
                if (wrongCards.length > 0) {
                    container.innerHTML = `
                        <div style="max-width: 600px; text-align: left; padding: 40px;">
                            <div style="font-size: 1.5rem; margin-bottom: 20px;"> Review Session</div>
                            <p style="color: var(--accent-gray); margin-bottom: 30px;">
                                You've completed all cards! Let's review the ${wrongCards.length} card${wrongCards.length > 1 ? 's' : ''} you found challenging.
                            </p>
                            <button onclick="reviewWrongCards()" class="btn primary" style="padding: 15px 30px; font-size: 1rem;">
                                Review Challenging Cards
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="max-width: 600px; text-align: left; padding: 40px;">
                            <div style="font-size: 2rem; margin-bottom: 20px;"> </div>
                            <div style="font-size: 1.3rem; margin-bottom: 15px;">Excellent Work!</div>
                            <p style="color: var(--accent-gray);">You've mastered all cards in this session.</p>
                        </div>
                    `;
                }
                return;
            }

            const card = cardsForLearn[currentCardIndexForLearn];
            currentCardId = card.id;
            cardStartTime = Date.now();
            shownCardIds.add(card.id);

            container.innerHTML = `
                <div style="max-width: 600px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <p style="color: var(--accent-gray); margin: 0;">Card ${currentCardIndexForLearn + 1} of ${cardsForLearn.length}</p>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="color: var(--accent-gray); font-size: 0.9rem;">
                                ${card.streak > 0 ? ` Streak: ${card.streak}` : ''}
                            </div>
                            <button id="editBtn_${card.id}" class="btn secondary" style="padding: 6px 12px; font-size: 0.85rem; position: relative; z-index: 10;">Edit</button>
                            <button id="deleteBtn_${card.id}" class="btn danger" style="padding: 6px 12px; font-size: 0.85rem; position: relative; z-index: 10;">Delete</button>
                        </div>
                    </div>

                    <div class="study-card" style="min-height: 450px; display: flex; flex-direction: column; justify-content: space-between; padding: 25px; margin-bottom: 20px; overflow-y: auto;">
                        <div style="overflow-y: auto; max-height: 250px;">
                            <div style="color: var(--accent-gray); margin-bottom: 12px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Question:</div>
                            <div id="cardFrontContent" style="font-size: 0.9rem; text-align: left; margin: 10px 0; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word;">
                                ${card.front}
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <div style="color: var(--accent-gray); margin-bottom: 8px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Your Answer:</div>
                            <textarea id="userAnswerInput" placeholder="Type your answer here..." style="background: #3a3a3a; border: 1px solid #5a7a8c; color: var(--text-light); padding: 12px; border-radius: 4px; width: 100%; min-height: 70px; max-height: 120px; resize: vertical; font-size: 0.9rem;"></textarea>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="previousLearnCard()" class="btn secondary" style="flex: 1;" ${currentCardIndexForLearn === 0 ? 'disabled' : ''}>‚Üê Previous</button>
                        <button onclick="revealAnswer()" class="btn primary" style="flex: 2;">Show Answer</button>
                        <button onclick="skipCard()" class="btn secondary" style="flex: 1;">Skip ‚Üí</button>
                    </div>
                </div>
            `;

            // Add event listeners after creating the buttons
            setTimeout(() => {
                const editBtn = document.getElementById(`editBtn_${card.id}`);
                const deleteBtn = document.getElementById(`deleteBtn_${card.id}`);
                
                if (editBtn) {
                    editBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Edit button clicked for card:', card.id);
                        editCardFromLearn(card.id);
                    });
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Delete button clicked for card:', card.id);
                        deleteCardFromLearn(card.id);
                    });
                }

                // Render LaTeX
                if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                    MathJax.typesetPromise().catch(err => console.log(err));
                }
            }, 50);
        }

        function reviewWrongCards() {
            const wrongCards = cardsForLearn.filter(c => c.timesWrong > 0);
            cardsForLearn = wrongCards;
            currentCardIndexForLearn = 0;
            shownCardIds.clear();
            displayCurrentCard();
        }

        function skipCard() {
            currentCardIndexForLearn++;
            displayCurrentCard();
        }

        function revealAnswer() {
            const card = app.cards.find(c => c.id === currentCardId);
            if (!card) {
                console.log('Card not found:', currentCardId);
                return;
            }

            const userAnswerEl = document.getElementById('userAnswerInput');
            const userAnswer = userAnswerEl ? userAnswerEl.value : '';
            const displayAnswer = userAnswer || '(No answer provided)';
            
            document.getElementById('userAnswerDisplay').textContent = displayAnswer;
            document.getElementById('feedbackCardContent').innerHTML = card.back;
            document.getElementById('answerFeedbackModal').classList.add('show');

            setTimeout(() => {
                if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                    MathJax.typesetPromise().catch(err => console.log(err));
                }
            }, 50);
        }

        function markCardConfidence(confidence) {
            const timeMs = Date.now() - cardStartTime;
            app.recordAttempt(currentCardId, confidence, timeMs);
            document.getElementById('answerFeedbackModal').classList.remove('show');
            currentCardIndexForLearn++;
            displayCurrentCard();
        }

        function previousLearnCard() {
            if (currentCardIndexForLearn > 0) {
                currentCardIndexForLearn--;
                displayCurrentCard();
            }
        }

        function updateLearnView() {
            const container = document.getElementById('learnContainer');
            
            let filterCategory = null;
            if (selectedParentCategoryId) {
                filterCategory = { type: 'parent', id: selectedParentCategoryId };
            } else if (selectedSubcategoryId) {
                filterCategory = { type: 'sub', id: selectedSubcategoryId };
            }

            let cards = app.getCardsByMode(currentStudyMode, filterCategory);

            if (cards.length === 0) {
                let message = 'No cards available.';
                if (currentStudyMode === 'new') {
                    message = 'No new cards to study. Try "All Cards" mode.';
                } else if (currentStudyMode === 'wrong') {
                    message = 'No missed cards! Great job! Try "All Cards" mode.';
                }
                
                container.innerHTML = `<p>${message} <a href="#" onclick="switchView('create')" style="color: #5a7a8c;">Create one!</a></p>`;
                return;
            }

            cards = cards.sort(() => Math.random() - 0.5);

            cardsForLearn = cards;
            currentCardIndexForLearn = 0;
            shownCardIds.clear();
            displayCurrentCard();
        }

        function updateAnalyticsView() {
            const stats = app.getAnalytics();
            const container = document.getElementById('analyticsContainer');

            let html = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">${stats.totalAttempts}</div>
                        <div class="stat-label">Total Study Sessions</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.averageAccuracy}%</div>
                        <div class="stat-label">Overall Accuracy</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.totalCorrect}</div>
                        <div class="stat-label">Correct Answers</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.totalWrong}</div>
                        <div class="stat-label">Incorrect Answers</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.masteredCards}</div>
                        <div class="stat-label">Mastered Cards</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.strugglingCards}</div>
                        <div class="stat-label">Need More Practice</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.averageConfidence}</div>
                        <div class="stat-label">Avg Confidence (0-3)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.averageTimePerCard}s</div>
                        <div class="stat-label">Avg Time per Card</div>
                    </div>
                </div>
            `;

            if (stats.mostMissedCards.length > 0) {
                html += `
                    <div style="margin-top: 40px;">
                        <h3 style="margin-bottom: 20px;">üìö Cards Needing Review</h3>
                        <div style="display: grid; gap: 12px;">
                `;

                stats.mostMissedCards.forEach(card => {
                    const accuracy = card.timesReviewed > 0 ? ((card.timesCorrect / card.timesReviewed) * 100).toFixed(1) : 0;
                    const sub = app.subcategories.find(s => s.id === card.subcategory);
                    
                    html += `
                        <div style="background: var(--card-bg); padding: 15px; border-radius: 6px; border-left: 4px solid ${accuracy < 50 ? '#8b4545' : accuracy < 75 ? '#8b7545' : '#4a6a4a'};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; gap: 10px;">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word;">Q: ${card.front}</div>
                                    <div style="color: #999; font-size: 0.85rem; margin-bottom: 8px; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word;">A: ${card.back}</div>
                                    <div style="font-size: 0.8rem; color: var(--accent-gray); display: flex; gap: 10px; flex-wrap: wrap;">
                                        <span> Wrong: ${card.timesWrong}x</span>
                                        <span> Correct: ${card.timesCorrect}x</span>
                                        <span> Accuracy: ${accuracy}%</span>
                                        <span>Last: ${['Wrong', 'Partial', 'Good', 'Perfect'][card.confidenceLevel] || 'N/A'}</span>
                                        <span> ${sub ? sub.name : 'Unknown'}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; white-space: nowrap; flex-shrink: 0;">
                                    <button onclick="editCard('${card.id}')" class="btn secondary" style="padding: 6px 12px; font-size: 0.75rem;">Edit</button>
                                    <button onclick="deleteCardFromAnalytics('${card.id}')" class="btn" style="background: #6a4a4a; padding: 6px 12px; font-size: 0.75rem; border: none; cursor: pointer;">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            } else {
                html += `
                    <div style="margin-top: 40px; text-align: left; padding: 40px; background: var(--card-bg); border-radius: 8px;">
                        <h3>üéØ Perfect Performance!</h3>
                        <p style="color: var(--accent-gray); margin-top: 10px;">You haven't missed any cards yet. Keep up the great work!</p>
                    </div>
                `;
            }

            container.innerHTML = html;
            
            // Render LaTeX in analytics view
            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                setTimeout(() => MathJax.typesetPromise().catch(err => console.log(err)), 100);
            }
        }

        let currentEditCardId = null;

        function editCard(cardId) {
            console.log('editCard called with ID:', cardId);
            currentEditCardId = cardId;
            const card = app.cards.find(c => c.id === cardId);
            if (!card) {
                console.error('Card not found:', cardId);
                return;
            }

            document.getElementById('editCardFrontInput').value = card.front;
            document.getElementById('editCardBackInput').value = card.back;
            document.getElementById('editCardModal').classList.add('show');
        }

        function editCardFromLearn(cardId) {
            console.log('editCardFromLearn called with ID:', cardId);
            editCard(cardId);
        }

        function closeEditCardModal() {
            document.getElementById('editCardModal').classList.remove('show');
            currentEditCardId = null;
        }

        function saveEditedCard() {
            if (!currentEditCardId) return;

            const front = document.getElementById('editCardFrontInput').value.trim();
            const back = document.getElementById('editCardBackInput').value.trim();

            if (!front || !back) {
                alert('Please fill in both fields');
                return;
            }

            app.updateCard(currentEditCardId, front, back);
            
            const cardIndex = cardsForLearn.findIndex(c => c.id === currentEditCardId);
            if (cardIndex !== -1) {
                const updatedCard = app.cards.find(c => c.id === currentEditCardId);
                if (updatedCard) {
                    cardsForLearn[cardIndex] = updatedCard;
                }
            }
            
            closeEditCardModal();
            
            const learnView = document.getElementById('learn');
            if (learnView && learnView.classList.contains('active')) {
                displayCurrentCard();
            }
            
            const analyticsView = document.getElementById('analytics');
            if (analyticsView && analyticsView.classList.contains('active')) {
                updateAnalyticsView();
            }
            
            alert('Card updated successfully!');
        }

        function deleteCardFromLearn(cardId) {
            console.log('deleteCardFromLearn called with ID:', cardId);
            if (confirm('Are you sure you want to delete this card? This action cannot be undone.')) {
                app.deleteCard(cardId);
                updateCategoriesNav();
                
                cardsForLearn = cardsForLearn.filter(c => c.id !== cardId);
                
                if (currentCardIndexForLearn >= cardsForLearn.length && cardsForLearn.length > 0) {
                    currentCardIndexForLearn = cardsForLearn.length - 1;
                }
                
                if (cardsForLearn.length > 0) {
                    displayCurrentCard();
                } else {
                    updateLearnView();
                }
                
                alert('Card deleted successfully!');
            }
        }

        function deleteCardFromAnalytics(cardId) {
            if (confirm('Delete this card? This action cannot be undone.')) {
                app.deleteCard(cardId);
                updateAnalyticsView();
                updateCategoriesNav();
            }
        }

        document.addEventListener('click', (e) => {
            if (e.target.id === 'categoryModal') {
                closeCategoryModal();
            }
            if (e.target.id === 'subcategoryModal') {
                closeSubcategoryModal();
            }
            if (e.target.id === 'editCardModal') {
                closeEditCardModal();
            }
            if (e.target.id === 'answerFeedbackModal') {
                document.getElementById('answerFeedbackModal').classList.remove('show');
            }
        });

        document.addEventListener('keydown', (e) => {
            const feedbackModal = document.getElementById('answerFeedbackModal');
            const editModal = document.getElementById('editCardModal');
            const categoryModal = document.getElementById('categoryModal');
            const subcategoryModal = document.getElementById('subcategoryModal');
            
            // Check if any modal is open
            const isAnyModalOpen = feedbackModal.classList.contains('show') || 
                                   editModal.classList.contains('show') || 
                                   categoryModal.classList.contains('show') || 
                                   subcategoryModal.classList.contains('show');
            
            // Check if focus is on input/textarea
            const focusedElement = document.activeElement;
            const isFocusedOnInput = focusedElement && (focusedElement.tagName === 'INPUT' || 
                                                        focusedElement.tagName === 'TEXTAREA' || 
                                                        focusedElement.tagName === 'SELECT');
            
            if (feedbackModal.classList.contains('show')) {
                if (e.key === '1') markCardConfidence(0);
                else if (e.key === '2') markCardConfidence(1);
                else if (e.key === '3') markCardConfidence(2);
                else if (e.key === '4') markCardConfidence(3);
            } else if (!isAnyModalOpen && !isFocusedOnInput && document.querySelector('.content.active')?.id === 'learn') {
                if (e.key === ' ' || e.key === 'Enter') {
                    e.preventDefault();
                    revealAnswer();
                }
            }
        });

        function initApp() {
            try {
                console.log('Initializing app...');
                updateCategoriesNav();
                updateParentCategoryDropdown();

                if (typeof MathJax !== 'undefined') {
                    MathJax.contentDocument = document;
                }
                console.log('App initialized successfully');
            } catch (e) {
                console.error('Initialization error:', e);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(initApp, 100);
            });
        } else {
            setTimeout(initApp, 100);
        }
    </script>
</body>
</html>